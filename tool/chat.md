# 大模型对话

## 数据获取

使用PostMan 工具，发送POST请求，获取数据
接口文档参考 [alert接口文档](https://kgwnvb.yuque.com/grmkz0/lymk39/wkin5i91vrtisbfh#LyPLc)

或者使用 data.py 脚本获取数据

```shell
python data.py
```

数据保存在alert_input.json和topology_input.json中

### 查询拓扑图接口

GET 192.168.1.20:31406/api/service/relation

### 查询告警事件数据

POST 192.168.1.20:31406/api/alerts/descendant/anormal/delta

## 对话流程

### 1.提示拓扑图

这里有一个微服务拓扑图，每层有节点名。上层节点和下层节点构成上游与下游关系，且为上游调用下游。请根据数据内容记住上下游服务关系的拓扑结构。
拓扑数据信息注意：

1.最上面的为入口节点, 空格代表层级，一定要记住节点在第几层
  
2.一个节点可能有多个下游节点，同时它还可能被多个上游节点调用，请不要遗漏任何节点 

3.不要创造不存在的上下游调用关系，不要弄反上下游关系，也不要遗漏上下游调用关系，拓扑结构中不要出现环，不要联想到其他东西，只需要记住给出微服务拓扑图，也不需要解释内容 (请多回顾一下注意信息中的节点概念，不要遗漏任何上下游节点)
4.所有节点按照名称标识，节点名称比较长，请不要压缩任何节点名称。

拓扑图数据会在之后给出。

### 2.提示告警事件, 给出拓扑图和告警事件数据

拓扑每个节点后会附带告警事件,告警事件为JSON格式数据。

第一层的KEY为节点名称

第二层的KEY为告警事件的类型,是数字，1接口层告警,2为容器异常,3为基础设施异常,4为网络程序异常,5为错误异常。
  
第三层的KEY含义如下
  - add新增告警事件数
  - duplicate重复告警事件数
  - resolve已经解决告警事件数
  - keep 目前还存留告警事件数
  - firstTime该类型告警事件第一次发生时间
  - lastTime该类型告警事件最后一次发生时间
  - resolveTime解决告警的时间(告警已解决才有)
  
回答已经记住这些告警事件，有告警事件的节点定义是节点出现在JSON数据中，没有告警事件的节点定义是节点未出现在JSON数据中。请输出拓扑结构、有告警事件的节点、没有告警事件的节点。

拓扑和告警事件数据如下

### 3.定义规则和判断流程，要求给出根因节点的结论

请根据上文提供的微服务拓扑图和每个节点的告警事件, 之后会提供以一个个规则找出符合规则的根因节点。

根因节点推导流程
    
1.根据告警事件中异常类型和发生次数，记录异常事件从下游往上游传递的顺序

2.每次给出一个规则后，排除符合规则的根因节点。

注意：在拓扑中，一个上游可能有多个下游节点，多个下游视为同级节点。如果同级节点中的服务都满足异常向上传递，那么这些下游节点都可认为是根因，且排除上游节点，不要遗漏节点。同时记得一定要排除入口节点。

### 提供一个个规则

- 规则1:告警事件类型 1接口层告警,2为容器异常,3为基础设施异常,4为网络程序异常,5为错误异常。没有告警事件的节点可以排除。

- 规则2:从应用接口层告警（如 URL 接口延时异常、错误异常）出发。
    沿着业务入口的拓扑结构，从上游向下游追踪（使用拓扑图数据，不要搞错上下游）。
    对于每个节点：
    如果存在接口层告警，继续向其依赖的下游节点追踪，如果没有下游依赖节点，停止追踪，标记为疑似根因。
    如果没有接口层告警，停止追踪，返回上一级节点，当前节点可以排除。
    在追踪过程中，对于每个有告警的节点：
    检查是否存在其他类型的告警（如应用层、容器层、基础设施层告警）。
    如果存在，则该节点可能是根因，记录并继续追踪。
    如果不存在其他告警，继续分析下游节点。
    最下游节点定义：依赖链路上没有进一步下游依赖的节点。最下游节点如果有告警，是疑似根因的优先候选。
    
- 规则3:根因节点需要满足异常从该节点开始向上游传递递，同时该类型异常告警事件是持续发生的，而不是偶发的
    如果接口层类型的告警既有新增又有解决，该节点可认为是偶发。
    但是接口层类型告警存在存留告警，该节点应做为疑似根因节点。
    节点的异常告警是偶发，那么它不应该被认定为根因节点
  
- 规则4:如果某个节点发生异常，但是上游节点未发生接口异常告警，可以将这个节点及其分支全部排除

### 汇总所有规则

汇总之前的节点信息，返回一个满足最多规则的根因的节点和最多三个疑似根因节点。
不需要其他任何额外信息,且节点名称一定完整。

最终的根因节点一定不能是入口节点（拓扑图中最上层的节点）。

回答格式:

    造成根因的是xxx节点。(如造成根因的是ts-train-service|POST travel节点)
    疑似根因节点有xxx。(xxx内可以有多个节点)